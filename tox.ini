[tox]
setupdir = .
skipsdist = True
envlist = typecheck, pytest, smoke_test, performance_test
basepython = python3.11

[testenv:typecheck]
commands =
    mypy --follow-imports=silent --ignore-missing-imports --explicit-package-bases --install-types --non-interactive {toxinidir}/tests/
deps =
    mypy==1.2.0
    types-requests
    types-PyYAML

[testenv:pytest]
passenv = ENVIRONMENT,PYTEST_RETRY_COUNT,API_TIMEOUT,PARALLEL_WORKERS
setenv =
    PYTHONPATH = {toxinidir}:{toxinidir}/tests
    ENVIRONMENT = {env:ENVIRONMENT:development}
    API_TIMEOUT = {env:API_TIMEOUT:30}
commands =
    pytest {toxinidir}/tests/end_to_end/ \
      --reruns {env:PYTEST_RETRY_COUNT:2} \
      --reruns-delay 2 \
      --html={toxinidir}/reports/test_report.html \
      --self-contained-html \
      --junitxml={toxinidir}/reports/junit.xml \
      -n {env:PARALLEL_WORKERS:4} \
      -v --tb=short
deps =
    -r{toxinidir}/requirements.txt

[testenv:smoke_test]
passenv = ENVIRONMENT,PYTEST_RETRY_COUNT,API_TIMEOUT
setenv =
    PYTHONPATH = {toxinidir}:{toxinidir}/tests
    ENVIRONMENT = {env:ENVIRONMENT:development}
    API_TIMEOUT = {env:API_TIMEOUT:15}
commands =
    pytest {toxinidir}/tests/end_to_end/ \
      -m "smoke" \
      --reruns {env:PYTEST_RETRY_COUNT:3} \
      --reruns-delay 1 \
      --html={toxinidir}/reports/smoke_report.html \
      --self-contained-html \
      --junitxml={toxinidir}/reports/smoke_junit.xml \
      -n 4 \
      -v --tb=short
deps =
    -r{toxinidir}/requirements.txt

[testenv:performance_test]
passenv = ENVIRONMENT,PERFORMANCE_DURATION,MAX_RPS,CONCURRENT_USERS
setenv =
    PYTHONPATH = {toxinidir}:{toxinidir}/tests
    ENVIRONMENT = {env:ENVIRONMENT:development}
    PERFORMANCE_DURATION = {env:PERFORMANCE_DURATION:60}
    MAX_RPS = {env:MAX_RPS:100}
commands =
    pytest {toxinidir}/tests/performance/ \
      --html={toxinidir}/reports/performance_report.html \
      --self-contained-html \
      --junitxml={toxinidir}/reports/performance_junit.xml \
      -v --tb=short
deps =
    -r{toxinidir}/requirements.txt

[testenv:test_tag]
passenv = ENVIRONMENT,PYTEST_RETRY_COUNT,PYTEST_TAG,API_TIMEOUT
setenv =
    PYTHONPATH = {toxinidir}:{toxinidir}/tests
    PYTEST_TAG = {env:PYTEST_TAG:smoke}
    ENVIRONMENT = {env:ENVIRONMENT:development}
    API_TIMEOUT = {env:API_TIMEOUT:30}
commands =
    pytest {toxinidir}/tests/end_to_end/ \
      -m "{env:PYTEST_TAG:smoke}" \
      --reruns {env:PYTEST_RETRY_COUNT:2} \
      --reruns-delay 2 \
      --html={toxinidir}/reports/tagged_test_report.html \
      --self-contained-html \
      --junitxml={toxinidir}/reports/tagged_junit.xml \
      -n 4 \
      -v --tb=short
deps =
    -r{toxinidir}/requirements.txt

[testenv:coverage]
commands =
    coverage run -m pytest {toxinidir}/tests/end_to_end/
    coverage report -m
    coverage html -d {toxinidir}/reports/coverage
deps =
    -r{toxinidir}/requirements.txt
    coverage
    pytest-cov
